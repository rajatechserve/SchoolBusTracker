<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bus Tracker Map</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .info-window {
      font-family: Arial, sans-serif;
      padding: 5px;
    }
    .info-window h3 {
      margin: 0 0 5px 0;
      color: #333;
    }
    .info-window p {
      margin: 0;
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <script>
    let map;
    let busMarker = null;
    let schoolMarker = null;
    let routePolyline = null;
    let busLocation = null;
    let schoolLocation = null;
    let routePath = [];
    let animationFrame = null;
    let isAnimating = false;

    // Custom bus icon as base64 SVG
    const busIcon = {
      url: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
          <path fill="#FF6B35" d="M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-3.58-4-8-4M7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17m9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5m1.5-7H6V6h12v4z"/>
        </svg>
      `),
      scaledSize: new google.maps.Size(48, 48),
      anchor: new google.maps.Point(24, 24)
    };

    // Custom school icon as base64 SVG
    const schoolIcon = {
      url: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24">
          <path fill="#4A90E2" d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3m0 13.7l-4-2.18v-3.2L12 13.5l4-2.18v3.2L12 16.7M12 6.26L18.78 9L12 11.74L5.22 9L12 6.26z"/>
        </svg>
      `),
      scaledSize: new google.maps.Size(40, 40),
      anchor: new google.maps.Point(20, 40)
    };

    function initMap() {
      // Default center (will be updated when bus location is received)
      const defaultCenter = { lat: 13.0827, lng: 80.2707 }; // Chennai, India
      
      map = new google.maps.Map(document.getElementById('map'), {
        center: defaultCenter,
        zoom: 15,
        mapTypeControl: true,
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: true,
        mapTypeId: 'roadmap',
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });

      // Notify React Native that map is ready
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'MAP_READY' }));
      }
    }

    // Smooth animation function using easing
    function animateMarker(marker, targetPosition, duration = 1000) {
      if (!marker || isAnimating) return;
      
      const startPosition = marker.getPosition();
      const startLat = startPosition.lat();
      const startLng = startPosition.lng();
      const targetLat = targetPosition.lat;
      const targetLng = targetPosition.lng;
      
      const startTime = Date.now();
      isAnimating = true;

      function easeInOutCubic(t) {
        return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
      }

      function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easedProgress = easeInOutCubic(progress);

        const currentLat = startLat + (targetLat - startLat) * easedProgress;
        const currentLng = startLng + (targetLng - startLng) * easedProgress;

        marker.setPosition({ lat: currentLat, lng: currentLng });

        // Calculate rotation angle based on direction
        const angle = google.maps.geometry.spherical.computeHeading(
          new google.maps.LatLng(startLat, startLng),
          new google.maps.LatLng(targetLat, targetLng)
        );
        
        marker.setIcon({
          ...busIcon,
          rotation: angle
        });

        if (progress < 1) {
          animationFrame = requestAnimationFrame(animate);
        } else {
          isAnimating = false;
        }
      }

      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
      animate();
    }

    // Update bus location
    function updateBusLocation(lat, lng, animate = true) {
      const position = { lat, lng };
      busLocation = position;

      if (!busMarker) {
        busMarker = new google.maps.Marker({
          position: position,
          map: map,
          icon: busIcon,
          title: 'School Bus',
          animation: google.maps.Animation.DROP
        });

        const infoWindow = new google.maps.InfoWindow({
          content: '<div class="info-window"><h3>üöå School Bus</h3><p>Live Location</p></div>'
        });

        busMarker.addListener('click', function() {
          infoWindow.open(map, busMarker);
        });

        // Center map on bus
        map.setCenter(position);
      } else {
        if (animate) {
          animateMarker(busMarker, position, 800);
        } else {
          busMarker.setPosition(position);
        }
      }

      // Update route path
      if (routePath.length === 0 || 
          routePath[routePath.length - 1].lat !== lat || 
          routePath[routePath.length - 1].lng !== lng) {
        routePath.push(position);
        updateRoute();
      }

      // Auto-center if bus moved significantly
      const bounds = map.getBounds();
      if (bounds && !bounds.contains(position)) {
        map.panTo(position);
      }
    }

    // Update school location
    function updateSchoolLocation(lat, lng) {
      const position = { lat, lng };
      schoolLocation = position;

      if (!schoolMarker) {
        schoolMarker = new google.maps.Marker({
          position: position,
          map: map,
          icon: schoolIcon,
          title: 'School',
          animation: google.maps.Animation.DROP
        });

        const infoWindow = new google.maps.InfoWindow({
          content: '<div class="info-window"><h3>üè´ School</h3><p>Destination</p></div>'
        });

        schoolMarker.addListener('click', function() {
          infoWindow.open(map, schoolMarker);
        });
      } else {
        schoolMarker.setPosition(position);
      }

      // Fit bounds to show both bus and school if both exist
      if (busLocation && schoolLocation) {
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(busLocation);
        bounds.extend(schoolLocation);
        map.fitBounds(bounds, 50);
      }
    }

    // Update route polyline
    function updateRoute() {
      if (routePolyline) {
        routePolyline.setMap(null);
      }

      if (routePath.length > 1) {
        routePolyline = new google.maps.Polyline({
          path: routePath,
          geodesic: true,
          strokeColor: '#FF6B35',
          strokeOpacity: 0.8,
          strokeWeight: 4,
          map: map
        });
      }
    }

    // Set route path (for predefined routes)
    function setRoutePath(path) {
      routePath = path;
      updateRoute();
    }

    // Clear route
    function clearRoute() {
      routePath = [];
      if (routePolyline) {
        routePolyline.setMap(null);
        routePolyline = null;
      }
    }

    // Center map on bus
    function centerOnBus() {
      if (busLocation) {
        map.panTo(busLocation);
        map.setZoom(16);
      }
    }

    // Center map on school
    function centerOnSchool() {
      if (schoolLocation) {
        map.panTo(schoolLocation);
        map.setZoom(16);
      }
    }

    // Fit bounds to show all markers
    function fitAllMarkers() {
      if (busLocation || schoolLocation) {
        const bounds = new google.maps.LatLngBounds();
        if (busLocation) bounds.extend(busLocation);
        if (schoolLocation) bounds.extend(schoolLocation);
        map.fitBounds(bounds, 100);
      }
    }

    // Handle messages from React Native
    window.addEventListener('message', function(event) {
      try {
        const data = JSON.parse(event.data);
        
        switch(data.type) {
          case 'UPDATE_BUS':
            updateBusLocation(data.lat, data.lng, data.animate !== false);
            break;
          case 'UPDATE_SCHOOL':
            updateSchoolLocation(data.lat, data.lng);
            break;
          case 'SET_ROUTE':
            setRoutePath(data.path);
            break;
          case 'CLEAR_ROUTE':
            clearRoute();
            break;
          case 'CENTER_BUS':
            centerOnBus();
            break;
          case 'CENTER_SCHOOL':
            centerOnSchool();
            break;
          case 'FIT_ALL':
            fitAllMarkers();
            break;
        }
      } catch (error) {
        console.error('Error parsing message:', error);
      }
    });

    // For Android WebView
    document.addEventListener('message', function(event) {
      window.dispatchEvent(new MessageEvent('message', { data: event.data }));
    });
  </script>
  
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=geometry&callback=initMap">
  </script>
</body>
</html>
